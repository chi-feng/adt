<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spectrogram Diff Tool</title>
    <style>
      :root {
        --color-background-darkest: #000;
        --color-background-dark: #000;
        --color-background-medium: #000;
        --color-background-light: #181818;
        --color-background-hover: #444;
        --color-text-light: #fff;
        --color-text-very-light: #ddd;
        --color-text-medium: #ccc;
        --color-text-dark: #666;
        --color-border: #111;
        --color-primary: #002e54;
        --color-primary-hover: #0066b3;
        --color-accent-green: #2ecc71;
        --color-tooltip-background: rgba(0, 0, 0, 0.85);
        --color-shadow: rgba(0, 0, 0, 0.5);
        font-size: 14px;
      }

      /* General body styling */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        margin: 0; /* Remove default margin */
        background: var(--color-background-darkest);
        color: var(--color-text-light);
        height: 100vh; /* Make body fill viewport height */
        overflow: hidden; /* Prevent body scrolling */
      }

      /* Grid container */
      .grid-container {
        display: grid;
        grid-template-columns: 240px 1fr; /* Fixed left column, flexible right */
        height: 100%;
        gap: 8px; /* Gap between columns */
        padding: 8px; /* Padding around the grid */
        box-sizing: border-box; /* Include padding in height/width */
      }

      /* Left column styling */
      .grid-left {
        display: flex;
        flex-direction: column;
        gap: 15px; /* Space between items */
        background: var(--color-background-medium); /* Slightly darker background */
        padding: 15px;
        overflow-y: auto; /* Allow scrolling if content overflows */
      }
      .grid-left h1 {
        font-size: 1.4rem; /* Slightly smaller title */
        font-weight: 500;
        margin: 0 0 10px 0; /* Adjust margin */
        padding-bottom: 5px;
      }
      .file-input {
        display: flex;
        flex-direction: column; /* Stack label and input */
        gap: 5px;
      }
      .file-input label {
        font-size: 0.9rem;
        color: var(--color-text-medium);
      }
      input[type="file"] {
        font-size: 0.9rem;
      }
      #status {
        font-style: italic;
        color: var(--color-text-dark);
        font-size: 0.85rem;
      }

      /* Right column styling */
      .grid-right {
        display: grid;
        grid-template-rows: auto 1fr 1fr; /* Top fixed, middle/bottom fill space */
        gap: 8px; /* Gap between rows */
        overflow: hidden; /* Prevent overflow */
      }

      /* Top Row: Spectrogram Section */
      .spectrogram-section {
        background: var(--color-background-light);
        overflow: hidden;
        display: flex; /* Use flex for internal layout */
        flex-direction: column;
        position: relative; /* Needed for overlay positioning */
      }
      .playback-controls {
        display: flex;
        align-items: center;
        padding: 8px; /* Adjusted padding */
        background: var(--color-background-medium); /* Consistent background */
        gap: 12px; /* Space between controls */
        flex-shrink: 0; /* Prevent shrinking */
      }
      .play-button {
        background: var(--color-primary);
        color: var(--color-text-light);
        border: none;

        width: 24px; /* Slightly larger */
        height: 24px; /* Slightly larger */
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .play-button:hover {
        background: var(--color-primary-hover);
      }
      .time-display {
        color: var(--color-text-dark);
        font-family: monospace;
        font-size: 0.9rem;
        flex-shrink: 0;
      }
      .time-range-display {
        font-family: monospace;
        color: var(--color-text-dark);
        font-size: 0.9rem;
        padding-right:8px;
        margin-left: auto; /* Push to the right */
        flex-shrink: 0;
      }
      .tabs {
        display: flex;
        background: var(--color-background-dark); /* Background for tab bar */
        flex-shrink: 0;
      }
      .tab-button {
        padding: 8px 15px;
        background: transparent; /* Transparent background */
        color: var(--color-text-medium);
        border: none;
        border-bottom: 1px solid transparent; /* Underline indicator */
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        position: relative; /* For playing indicator */
        margin-right: 1px; /* Small gap */
      }
      .tab-button:hover {
        background: var(--color-background-hover);
        color: var(--color-text-light);
      }
      .tab-button.active {
        background: var(--color-background-light); /* Match section background */
        color: var(--color-text-light);
        border-bottom: 1px solid var(--color-primary); /* Active indicator */
      }
      .playing-indicator {
        /* Style for the green dot */
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: var(--color-accent-green); /* Green color */

        margin-left: 6px;
        vertical-align: middle;
        animation: pulse 1.5s infinite ease-in-out;
        visibility: hidden; /* Hide by default, but reserve space */
      }
      .tab-button.is-playing .playing-indicator {
        visibility: visible; /* Show when parent has class */
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
        100% {
          opacity: 1;
        }
      }

      .tab-content-container {
        flex-grow: 1; /* Allow container to fill space */
        position: relative; /* For overlay positioning */
        overflow: hidden; /* Clip content */
        height: 256px; /* Enforce fixed height for spectrogram display area */
      }
      .tab-content {
        display: none;
        height: 100%; /* Fill container */
        overflow: hidden; /* Prevent inner scroll */
      }
      .tab-content.active {
        display: block;
      }
      .canvas-container {
        /* Wraps each spectrogram canvas */
        position: relative; /* Needed? */
        width: 100%;
        height: 100%; /* Fill tab content area */
      }
      canvas.spectrogram {
        display: block;
        width: 100%; /* Stretch horizontally */
        height: 100%; /* Stretch vertically to fill container */
        background: var(--color-background-darkest);
        cursor: crosshair;
      }
      #playbackOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
        mix-blend-mode: screen;
        /* border: 1px dashed lime; */ /* Debugging */
      }
      #spectrogram-tooltip {
        position: fixed;
        background: var(--color-tooltip-background);
        border: 1px solid var(--color-border);

        padding: 5px 8px;
        font-family: monospace;
        font-size: 12px;
        color: var(--color-text-light);
        pointer-events: none;
        z-index: 9999;
        display: none;
        white-space: nowrap;
        transform: translate(5px, 5px);
        box-shadow: 0 2px 5px var(--color-shadow);
      }

      /* Middle/Bottom Rows: Spectrum Chart Sections */
      .spectrum-chart-section,
      .spectrum-diff-chart-section {
        background: var(--color-background-light);
        display: flex; /* Use flex to make canvas fill space */
        flex-direction: column;
        overflow: hidden; /* Prevent content spilling */
      }
      /* Add rule to hide diff chart section by default */
      .spectrum-diff-chart-section.hidden {
          display: none;
      }
      .spectrum-chart-section h3,
      .spectrum-diff-chart-section h3 {
        /* Simple titles */
        margin: 0 0 5px 0;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--color-text-medium);
        flex-shrink: 0; /* Prevent title shrinking */
      }
      .chart-container {
        /* Wrapper for canvas to control size */
        flex-grow: 1; /* Allow container to fill space */
        position: relative; /* For potential absolute positioning inside */
        overflow: hidden; /* Clip canvas if needed */
        background: var(--color-background-dark); /* Background for chart area */
      }
      .chart-container canvas {
        display: block; /* Remove extra space below canvas */
        width: 100%;
        height: 100%;
      }
      .button {
        background: var(--color-primary);
        color: var(--color-text-light);
        border: none;
        padding: 8px;
        margin-top: 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <!-- Left Column -->
      <div class="grid-left">
        <h1 id="main-title">Audio Diff Tool</h1>
        <div id="status">Please select two audio files.</div>
        <div class="file-input" id="file-input-1">
          <label for="audioFile1">File 1 (or select both files)</label>
          <input type="file" id="audioFile1" accept="audio/*" multiple />
        </div>
        <div class="file-input" id="file-input-2">
          <label for="audioFile2">File 2</label>
          <input type="file" id="audioFile2" accept="audio/*" />
        </div>
        <!-- Add Swap Button -->
        <button id="swapFilesButton" class="button">Swap Files</button>
        <div
          class="instructions"
          style="font-size: 0.8rem; color: #999; margin-top: 10px"
        >
          Load two audio files. Click and drag on the spectrogram to select a
          time range for analysis and looping. Use 1, 2, or 3 to switch views,
          Space to play/pause.
        </div>
      </div>

      <!-- Right Column -->
      <div class="grid-right">
        <!-- Top Row: Spectrogram -->
        <div class="spectrogram-section">
          <div class="tabs">
            <button id="tab1" class="tab-button active" data-tab="file1-tab">
              File 1
              <span class="playing-indicator"></span>
            </button>
            <button id="tab2" class="tab-button" data-tab="file2-tab">
              File 2
              <span class="playing-indicator"></span>
            </button>
            <button id="tab3" class="tab-button" data-tab="diff-tab">
              Difference
            </button>
          </div>
          <div class="playback-controls">
            <button id="playButton" class="play-button">▶</button>
            <div class="time-display">
              <span id="currentTime">0:00</span> /
              <span id="totalTime">0:00</span>
            </div>
            <div class="time-range-display">
              Selection: <span id="spectrumTimeRange">0:00 - 0:00</span>
            </div>
          </div>          
          <div class="tab-content-container">
            <!-- Added container -->
            <div id="file1-tab" class="tab-content active">
              <div class="canvas-container">
                <canvas id="spectrogramCanvas1" class="spectrogram"></canvas>
                <!-- Removed fixed size -->
              </div>
            </div>
            <div id="file2-tab" class="tab-content">
              <div class="canvas-container">
                <canvas id="spectrogramCanvas2" class="spectrogram"></canvas>
                <!-- Removed fixed size -->
              </div>
            </div>
            <div id="diff-tab" class="tab-content">
              <div class="canvas-container">
                <canvas id="diffSpectrogramCanvas" class="spectrogram"></canvas>
                <!-- Removed fixed size -->
              </div>
            </div>
            <!-- Overlay covers the tab-content-container -->
            <canvas id="playbackOverlay"></canvas>
            <!-- Removed fixed size -->
            <div id="spectrogram-tooltip"></div>
          </div>
        </div>

        <!-- Middle Row: Spectrum Analysis -->
        <div class="spectrum-chart-section">
          <div class="chart-container">
            <canvas id="frequencySpectrumChart"></canvas>
          </div>
        </div>

        <!-- Bottom Row: Spectral Difference -->
        <div class="spectrum-diff-chart-section hidden">
          <div class="chart-container">
            <canvas id="spectralDifferenceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- External dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="fft.js"></script>

    <!-- Application modules -->
    <script src="config.js"></script>
    <script src="audio.js"></script>
    <script src="visualization.js"></script>
    <script src="ui.js"></script>
    <script src="spectrum.js"></script>
    <script src="main.js"></script>
  </body>
</html>
