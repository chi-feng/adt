<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spectrogram Diff Tool</title>
    <style>
      /* ===== CSS Variables ===== */
      :root {
        /* Color Palette */
        --color-background-darkest: #000;
        --color-background-dark: #000;
        --color-background-medium: #000;
        --color-background-light: #181818;
        --color-background-hover: #444;
        
        --color-text-light: #fff;
        --color-text-very-light: #ddd;
        --color-text-medium: #ccc;
        --color-text-dark: #666;
        
        --color-border: #111;
        --color-primary: #002e54;
        --color-primary-hover: #0066b3;
        --color-accent-green: #2ecc71;
        
        --color-tooltip-background: rgba(0, 0, 0, 0.85);
        --color-shadow: rgba(0, 0, 0, 0.5);
        
        /* Typography */
        --font-size-base: 14px;
        --font-size-small: 0.9rem;
        --font-size-xs: 0.85rem;
        --font-size-xxs: 0.8rem;
        
        /* Spacing */
        --spacing-xs: 5px;
        --spacing-sm: 8px;
        --spacing-md: 10px;
        --spacing-lg: 12px;
        --spacing-xl: 15px;
        
        font-size: var(--font-size-base);
      }

      /* ===== Reset & Base Styles ===== */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: var(--font-size-base);
        margin: 0;
        background: var(--color-background-darkest);
        color: var(--color-text-light);
        height: 100vh;
        overflow: hidden;
      }

      /* ===== Layout ===== */
      .grid-container {
        display: grid;
        grid-template-columns: 240px 1fr;
        height: 100%;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        box-sizing: border-box;
      }

      /* Left Panel */
      .grid-left {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xl);
        background: var(--color-background-medium);
        padding: var(--spacing-xl);
        overflow-y: auto;
      }

      .grid-left h1 {
        font-size: 1.4rem;
        font-weight: 500;
        margin: 0 0 var(--spacing-md) 0;
        padding-bottom: var(--spacing-xs);
      }

      /* Right Panel */
      .grid-right {
        display: grid;
        grid-template-rows: auto 3fr 2fr;
        gap: var(--spacing-sm);
        overflow: hidden;
      }

      /* ===== Components ===== */
      /* File Input */
      .file-input {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .file-input label {
        font-size: var(--font-size-small);
        color: var(--color-text-medium);
      }

      input[type="file"] {
        font-size: var(--font-size-small);
      }

      #status {
        font-style: italic;
        color: var(--color-text-dark);
        font-size: var(--font-size-xs);
      }

      .instructions {
        font-size: var(--font-size-xxs);
        color: var(--color-text-dark);
        margin-top: var(--spacing-md);
      }

      /* Buttons */
      .button, .play-button {
        background: var(--color-primary);
        color: var(--color-text-light);
        border: none;
        cursor: pointer;
      }

      .button {
        padding: var(--spacing-sm);
        margin-top: var(--spacing-md);
      }

      .button:hover, .play-button:hover {
        background: var(--color-primary-hover);
      }

      .play-button {
        width: 24px;
        height: 24px;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      /* ===== Spectrogram Section ===== */
      .spectrogram-section {
        background: var(--color-background-light);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      /* Tabs */
      .tabs {
        display: flex;
        background: var(--color-background-dark);
        flex-shrink: 0;
      }

      .tab-button {
        padding: var(--spacing-sm) var(--spacing-xl);
        background: transparent;
        color: var(--color-text-medium);
        border: none;
        border-bottom: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        position: relative;
        margin-right: 1px;
      }

      .tab-button:hover {
        background: var(--color-background-hover);
        color: var(--color-text-light);
      }

      .tab-button.active {
        background: var(--color-background-light);
        color: var(--color-text-light);
        border-bottom: 1px solid var(--color-primary);
      }

      /* Playing Indicator */
      .playing-indicator {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: var(--color-accent-green);
        margin-left: 6px;
        vertical-align: middle;
        animation: pulse 1.5s infinite ease-in-out;
        visibility: hidden;
      }

      .tab-button.is-playing .playing-indicator {
        visibility: visible;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
      }

      /* Playback Controls */
      .playback-controls {
        display: flex;
        align-items: center;
        padding: var(--spacing-sm);
        background: var(--color-background-medium);
        gap: var(--spacing-lg);
        flex-shrink: 0;
      }

      .time-display, .time-range-display {
        font-family: monospace;
        color: var(--color-text-dark);
        font-size: var(--font-size-small);
        flex-shrink: 0;
      }

      .time-range-display {
        padding-right: var(--spacing-sm);
        margin-left: auto;
      }

      /* Tab Content */
      .tab-content-container {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
        height: 256px;
      }

      .tab-content {
        display: none;
        height: 100%;
        overflow: hidden;
      }

      .tab-content.active {
        display: block;
      }

      /* Canvas Elements */
      .canvas-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      canvas.spectrogram {
        display: block;
        width: 100%;
        height: 100%;
        background: var(--color-background-darkest);
        cursor: crosshair;
      }

      #playbackOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
        mix-blend-mode: screen;
      }

      /* Tooltip */
      #spectrogram-tooltip {
        position: fixed;
        background: var(--color-tooltip-background);
        border: 1px solid var(--color-border);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-family: monospace;
        font-size: 12px;
        color: var(--color-text-light);
        pointer-events: none;
        z-index: 9999;
        display: none;
        white-space: nowrap;
        transform: translate(5px, 5px);
        box-shadow: 0 2px 5px var(--color-shadow);
      }

      /* ===== Spectrum Chart Sections ===== */
      .spectrum-chart-section,
      .spectrum-diff-chart-section {
        background: var(--color-background-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .spectrum-diff-chart-section.hidden {
        display: none;
      }

      .spectrum-chart-section h3,
      .spectrum-diff-chart-section h3 {
        margin: 0 0 var(--spacing-xs) 0;
        font-size: var(--font-size-small);
        font-weight: 500;
        color: var(--color-text-medium);
        flex-shrink: 0;
      }

      .chart-container {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
        background: var(--color-background-dark);
      }

      .chart-container canvas {
        display: block;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <!-- Left Column -->
      <div class="grid-left">
        <h1 id="main-title">Audio Diff Tool</h1>
        <div id="status">Please select two audio files.</div>
        <div class="file-input" id="file-input-1">
          <label for="audioFile1">File 1 (or select both files)</label>
          <input type="file" id="audioFile1" accept="audio/*" multiple />
        </div>
        <div class="file-input" id="file-input-2">
          <label for="audioFile2">File 2</label>
          <input type="file" id="audioFile2" accept="audio/*" />
        </div>
        <!-- Add Swap Button -->
        <button id="swapFilesButton" class="button">Swap Files</button>
        <div class="instructions">
          Load two audio files. Click and drag on the spectrogram to select a
          time range for analysis and looping. Use 1, 2, or 3 to switch views,
          Space to play/pause.
        </div>
      </div>

      <!-- Right Column -->
      <div class="grid-right">
        <!-- Top Row: Spectrogram -->
        <div class="spectrogram-section">
          <div class="tabs">
            <button id="tab1" class="tab-button active" data-tab="file1-tab">
              File 1
              <span class="playing-indicator"></span>
            </button>
            <button id="tab2" class="tab-button" data-tab="file2-tab">
              File 2
              <span class="playing-indicator"></span>
            </button>
            <button id="tab3" class="tab-button" data-tab="diff-tab">
              Difference
            </button>
          </div>
          <div class="playback-controls">
            <button id="playButton" class="play-button">â–¶</button>
            <div class="time-display">
              <span id="currentTime">0:00</span> /
              <span id="totalTime">0:00</span>
            </div>
            <div class="time-range-display">
              Selection: <span id="spectrumTimeRange">0:00 - 0:00</span>
            </div>
          </div>          
          <div class="tab-content-container">
            <!-- Added container -->
            <div id="file1-tab" class="tab-content active">
              <div class="canvas-container">
                <canvas id="spectrogramCanvas1" class="spectrogram"></canvas>
              </div>
            </div>
            <div id="file2-tab" class="tab-content">
              <div class="canvas-container">
                <canvas id="spectrogramCanvas2" class="spectrogram"></canvas>
              </div>
            </div>
            <div id="diff-tab" class="tab-content">
              <div class="canvas-container">
                <canvas id="diffSpectrogramCanvas" class="spectrogram"></canvas>
              </div>
            </div>
            <!-- Overlay covers the tab-content-container -->
            <canvas id="playbackOverlay"></canvas>
            <div id="spectrogram-tooltip"></div>
          </div>
        </div>

        <!-- Middle Row: Spectrum Analysis -->
        <div class="spectrum-chart-section">
          <div class="chart-container">
            <canvas id="frequencySpectrumChart"></canvas>
          </div>
        </div>

        <!-- Bottom Row: Spectral Difference -->
        <div class="spectrum-diff-chart-section hidden">
          <div class="chart-container">
            <canvas id="spectralDifferenceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- External dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="fft.js"></script>

    <!-- Application modules -->
    <script src="config.js"></script>
    <script src="audio.js"></script>
    <script src="visualization.js"></script>
    <script src="ui.js"></script>
    <script src="spectrum.js"></script>
    <script src="main.js"></script>
  </body>
</html>
